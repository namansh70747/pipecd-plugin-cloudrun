# PipeCD Cloud Run Plugin - Visual Guide

This guide uses visual diagrams to explain how the plugin works.

## System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           YOUR LAPTOP / SERVER                               │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         Piped (Agent)                                │    │
│  │                                                                      │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │    │
│  │  │  Git Repo    │  │ Plugin Mgr   │  │   Logger     │             │    │
│  │  │  (apps)      │  │              │  │              │             │    │
│  │  └──────┬───────┘  └──────┬───────┘  └──────────────┘             │    │
│  │         │                 │                                        │    │
│  │         │    ┌────────────┴────────────┐                          │    │
│  │         │    │                         │                          │    │
│  │         │    ▼                         ▼                          │    │
│  │         │  ┌─────────────────────────────────────────────────┐    │    │
│  │         │  │         Cloud Run Plugin (gRPC :7001)            │    │    │
│  │         │  │                                                   │    │    │
│  │         │  │  ┌─────────────┐  ┌─────────────┐  ┌───────────┐ │    │    │
│  │         └──┼─▶│ SYNC Stage  │  │PROMOTE Stage│  │ CLEANUP   │ │    │    │
│  │            │  │             │  │             │  │ Stage     │ │    │    │
│  │            │  └─────────────┘  └─────────────┘  └───────────┘ │    │    │
│  │            │                                                   │    │    │
│  │            │  ┌─────────────────────────────────────────────┐ │    │    │
│  │            │  │      Cloud Run API Client (Go SDK)           │ │    │    │
│  │            │  └─────────────────────────────────────────────┘ │    │    │
│  │            └───────────────────────────────────────────────────┘    │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                         │
│                                    │ HTTPS                                    │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     GOOGLE CLOUD PLATFORM                            │    │
│  │                                                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │                      Cloud Run                                │    │    │
│  │  │                                                              │    │    │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │    │    │
│  │  │  │  Service A  │  │  Service B  │  │  Service C  │         │    │    │
│  │  │  │  ┌───────┐  │  │  ┌───────┐  │  │  ┌───────┐  │         │    │    │
│  │  │  │  │ Rev 3 │  │  │  │ Rev 2 │  │  │  │ Rev 1 │  │         │    │    │
│  │  │  │  │ 100%  │  │  │  │ 100%  │  │  │  │ 100%  │  │         │    │    │
│  │  │  │  └───────┘  │  │  └───────┘  │  │  └───────┘  │         │    │    │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘         │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Deployment Flow

### Quick Sync Deployment

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│  User   │────▶│   Git   │────▶│ Control │────▶│  Piped  │────▶│  Plugin │
│  Push   │     │  Commit │     │  Plane  │     │  Agent  │     │  SYNC   │
└─────────┘     └─────────┘     └─────────┘     └─────────┘     └────┬────┘
                                                                     │
                                                                     │ HTTPS
                                                                     ▼
                                                               ┌─────────┐
                                                               │  Cloud  │
                                                               │   Run   │
                                                               │  Deploy │
                                                               └────┬────┘
                                                                    │
                                                                    │ 100%
                                                                    ▼
                                                               ┌─────────┐
                                                               │ Traffic │
                                                               │  Route  │
                                                               └─────────┘
```

### Canary Deployment Flow

```
Time ──────────────────────────────────────────────────────────────────────▶

Stage 1: SYNC (0% traffic)
┌─────────────────────────────────────────────────────────────────────────┐
│  ┌──────────┐                                                           │
│  │  New     │                                                           │
│  │ Revision │                                                           │
│  │   0%     │                                                           │
│  └──────────┘                                                           │
│                                                                          │
│  ┌──────────┐                                                           │
│  │   Old    │                                                           │
│  │ Revision │                                                           │
│  │  100%    │                                                           │
│  └──────────┘                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
Stage 2: PROMOTE (10% traffic)
┌─────────────────────────────────────────────────────────────────────────┐
│  ┌──────────┐                                                           │
│  │  New     │                                                           │
│  │ Revision │                                                           │
│  │   10%    │  ◀── 10% of users see new version                        │
│  └──────────┘                                                           │
│                                                                          │
│  ┌──────────┐                                                           │
│  │   Old    │                                                           │
│  │ Revision │                                                           │
│  │   90%    │  ◀── 90% of users see old version                         │
│  └──────────┘                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
Stage 3: PROMOTE (50% traffic)
┌─────────────────────────────────────────────────────────────────────────┐
│  ┌──────────┐                                                           │
│  │  New     │                                                           │
│  │ Revision │                                                           │
│  │   50%    │  ◀── 50% of users see new version                        │
│  └──────────┘                                                           │
│                                                                          │
│  ┌──────────┐                                                           │
│  │   Old    │                                                           │
│  │ Revision │                                                           │
│  │   50%    │  ◀── 50% of users see old version                         │
│  └──────────┘                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
Stage 4: PROMOTE (100% traffic)
┌─────────────────────────────────────────────────────────────────────────┐
│  ┌──────────┐                                                           │
│  │  New     │                                                           │
│  │ Revision │                                                           │
│  │  100%    │  ◀── All users see new version                            │
│  └──────────┘                                                           │
│                                                                          │
│  ┌──────────┐                                                           │
│  │   Old    │                                                           │
│  │ Revision │                                                           │
│  │   0%     │  ◀── No traffic to old version                             │
│  └──────────┘                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
Stage 5: CLEANUP
┌─────────────────────────────────────────────────────────────────────────┐
│  ┌──────────┐                                                           │
│  │  New     │                                                           │
│  │ Revision │  ◀── Only new revision kept                               │
│  │  100%    │                                                           │
│  └──────────┘                                                           │
│                                                                          │
│  Old revision deleted to save resources                                  │
└─────────────────────────────────────────────────────────────────────────┘
```

## Traffic Splitting Visualization

### Before Promotion (0%)

```
                    ┌─────────────────┐
                    │   Load Balancer │
                    │   (Cloud Run)   │
                    └────────┬────────┘
                             │
            ┌────────────────┴────────────────┐
            │                                 │
            ▼                                 ▼
   ┌─────────────────┐               ┌─────────────────┐
   │   Old Revision  │               │   New Revision  │
   │   (v1.0.0)      │               │   (v1.1.0)      │
   │                 │               │                 │
   │   100% Traffic  │               │    0% Traffic   │
   │   ████████████  │               │                 │
   │                 │               │                 │
   │   Users: 1000   │               │   Users: 0      │
   └─────────────────┘               └─────────────────┘
```

### During Canary (10%)

```
                    ┌─────────────────┐
                    │   Load Balancer │
                    │   (Cloud Run)   │
                    └────────┬────────┘
                             │
            ┌────────────────┴────────────────┐
            │                                 │
            ▼                                 ▼
   ┌─────────────────┐               ┌─────────────────┐
   │   Old Revision  │               │   New Revision  │
   │   (v1.0.0)      │               │   (v1.1.0)      │
   │                 │               │                 │
   │   90% Traffic   │               │   10% Traffic   │
   │   ██████████░   │               │   █             │
   │                 │               │                 │
   │   Users: 900    │               │   Users: 100    │
   └─────────────────┘               └─────────────────┘
```

### Full Promotion (100%)

```
                    ┌─────────────────┐
                    │   Load Balancer │
                    │   (Cloud Run)   │
                    └────────┬────────┘
                             │
            ┌────────────────┴────────────────┐
            │                                 │
            ▼                                 ▼
   ┌─────────────────┐               ┌─────────────────┐
   │   Old Revision  │               │   New Revision  │
   │   (v1.0.0)      │               │   (v1.1.0)      │
   │                 │               │                 │
   │    0% Traffic   │               │  100% Traffic   │
   │                 │               │   ████████████  │
   │                 │               │                 │
   │   Users: 0      │               │   Users: 1000   │
   └─────────────────┘               └─────────────────┘
```

## Plugin Interface Implementation

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     DeploymentPlugin Interface                           │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  FetchDefinedStages()                                            │    │
│  │  └── Returns: ["CLOUDRUN_SYNC", "CLOUDRUN_PROMOTE", ...]         │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  DetermineVersions()                                             │    │
│  │  └── Extracts version from container image                       │    │
│  │      Returns: {version: "v1.0.0", image: "gcr.io/..."}           │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  DetermineStrategy()                                             │    │
│  │  └── Checks if pipeline is defined                               │    │
│  │      Returns: QuickSync or PipelineSync                          │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  BuildQuickSyncStages()                                          │    │
│  │  └── Returns: [SYNC stage]                                       │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  BuildPipelineSyncStages()                                       │    │
│  │  └── Returns: [SYNC, PROMOTE, WAIT, PROMOTE, ...]                │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  ExecuteStage(stageName)                                         │    │
│  │  └── Executes the specified stage                                │    │
│  │      Returns: SUCCESS or FAILURE                                 │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Configuration Hierarchy

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Configuration Hierarchy                               │
│                                                                          │
│  Level 1: Plugin Config (piped.yaml)                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  plugins:                                                        │    │
│  │    - name: cloudrun                                              │    │
│  │      config:                                                     │    │
│  │        projectID: default-project     ◀── Global default         │    │
│  │        region: us-central1                                     │    │
│  │      deployTargets:                                              │    │
│  │        - name: staging                                           │    │
│  │          config:                                                 │    │
│  │            projectID: staging-project ◀── Environment-specific   │    │
│  │            region: us-central1                                 │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  Level 2: Application Config (.pipe.yaml)                                │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  spec:                                                           │    │
│  │    input:                                                        │    │
│  │      projectID: app-project           ◀── App-specific override  │    │
│  │      image: gcr.io/.../app:v1.0.0                              │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  Level 3: Stage Config (pipeline stages)                                 │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  pipeline:                                                       │    │
│  │    stages:                                                       │    │
│  │      - name: CLOUDRUN_PROMOTE                                    │    │
│  │        with:                                                     │    │
│  │          percent: 10                  ◀── Stage-specific         │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  Priority: Stage > App > Deploy Target > Plugin                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Error Handling Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Error Handling                                   │
│                                                                          │
│  Normal Flow:                                                            │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐               │
│  │  SYNC   │───▶│ PROMOTE │───▶│ PROMOTE │───▶│ CLEANUP │               │
│  │  (OK)   │    │  (OK)   │    │  (OK)   │    │  (OK)   │               │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘               │
│                                                                          │
│  Error Flow:                                                             │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐                              │
│  │  SYNC   │───▶│ PROMOTE │───▶│ PROMOTE │ X                            │
│  │  (OK)   │    │  (OK)   │    │ (FAIL)  │                              │
│  └─────────┘    └─────────┘    └────┬────┘                              │
│                                     │                                    │
│                                     │ Triggers rollback                  │
│                                     ▼                                    │
│                              ┌─────────┐                                 │
│                              │ROLLBACK │                                 │
│                              │  (OK)   │                                 │
│                              └────┬────┘                                 │
│                                   │                                      │
│                                   ▼                                      │
│                              ┌─────────┐                                 │
│                              │ CLEANUP │                                 │
│                              │  (OK)   │                                 │
│                              └─────────┘                                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Data Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Data Flow                                      │
│                                                                          │
│  Git Repository                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  my-app/                                                         │    │
│  │  ├── .pipe.yaml          ───────┐                                │    │
│  │  ├── service.yaml       ────────┼──▶  Piped reads these files   │    │
│  │  └── src/                        │                                │    │
│  └──────────────────────────────────┼────────────────────────────────┘    │
│                                     │                                     │
│                                     ▼                                     │
│  Plugin                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  1. Parse .pipe.yaml                                             │    │
│  │  2. Parse service.yaml                                           │    │
│  │  3. Apply image override                                         │    │
│  │  4. Build service object                                         │    │
│  └──────────────────────────────────┼────────────────────────────────┘    │
│                                     │                                     │
│                                     ▼                                     │
│  Cloud Run API                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  POST /v2/projects/.../services                                  │    │
│  │  Body: {service object}                                          │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

This visual guide should help you understand how the PipeCD Cloud Run Plugin works at a glance!
